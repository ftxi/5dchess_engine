name: Build Wheels

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }} with ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # -----------------------
          # Linux / GCC 13
          # -----------------------
          - os: ubuntu-22.04
            compiler: gcc
            cc: gcc-13
            cxx: g++-13

          # -----------------------
          # macOS / Apple Clang
          # -----------------------
          - os: macos-15
            compiler: apple-clang
            cc: clang
            cxx: clang++

          # -----------------------
          # Windows / MSVC
          # -----------------------
          - os: windows-2022
            compiler: msvc
            msvc_toolset: 14.40

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      # -----------------------
      # Install compilers
      # -----------------------

      - name: Setup GCC 13 (Linux)
        if: matrix.compiler == 'gcc'
        uses: aminya/setup-cpp@v1
        with:
          compiler: ${{ matrix.cc }}
          cmake: true

      - name: Setup MSVC (Windows)
        if: matrix.compiler == 'msvc'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          toolset: ${{ matrix.msvc_toolset }}

      # macOS uses system Apple Clang — no setup needed

      # -----------------------
      # Configure
      # -----------------------

      - name: Configure CMake
        shell: bash
        run: |
          if [ "${{ matrix.compiler }}" != "msvc" ]; then
            export CC=$(which ${{ matrix.cc }})
            export CXX=$(which ${{ matrix.cxx }})
          fi

          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      # -----------------------
      # Build
      # -----------------------

      - name: Build
        run: cmake --build build --config Release --parallel

      # -----------------------
      # Collect artifacts
      # -----------------------

      - name: Find engine artifact
        id: findfile
        shell: bash
        run: |
          FILE=$(find build -type f \( -name "engine*.so" -o -name "engine*.pyd" \) | head -n 1)

          if [ -z "$FILE" ]; then
            echo "❌ No engine artifact found"
            exit 1
          fi

          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: engine-${{ matrix.os }}-${{ matrix.compiler }}
          path: ${{ steps.findfile.outputs.file }}

  # -----------------------
  # Release job
  # -----------------------

  release:
    name: Upload wheels to release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            **/engine*.so
            **/engine*.pyd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
